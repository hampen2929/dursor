# Court検出の安定化に向けた改善案

本ドキュメントでは、TNet Cascade RT-DETRモデルにおけるコート検出の安定性（Stability）と精度（Accuracy）を向上させるための具体的な施策を、優先度付きで提案します。

## 課題の背景
現状の検出モデルでは、以下の課題が観測されています：
- 照明条件の変化や影による検出精度の低下
- プレイヤーや障害物によるオクルージョン発生時の検出漏れ
- 動画処理時のフレーム間での検出ボックスのブレ（Jitter）

## 改善施策一覧

### P1（高優先）: データオーグメンテーションの強化
学習データの多様性を高め、ロバスト性を向上させるための施策。

1. **照明・色調変換**:
   - 明度、コントラスト、彩度のランダムな変化を適用し、屋内・屋外や天候の変化に対応させる。
   - RandAugment等の自動増強手法の導入検討。

2. **オクルージョン・シミュレーション**:
   - Random ErasingやCutoutを用いて、コートラインの一部が隠れた状態を擬似的に作り出し、部分的な情報からでも全体を推論できる能力を強化する。
   - MixupやMosaicなどの強力なAugmentationを適用し、複雑な背景への耐性を高める。

3. **幾何学的変換**:
   - 視点変更（Perspective Transform）をランダムに適用し、様々なカメラアングルからの検出精度を向上させる。

### P2（中優先）: 時間的整合性（Temporal Consistency）の導入
動画としての連続性を利用し、単一フレームでの検出ミスを補正する。

1. **トラッキング・平滑化処理**:
   - ByteTrackやDeepSORTなどのトラッキングアルゴリズムと連携し、ID維持による安定化を図る。
   - 検出されたコートの四隅の座標に対して、カルマンフィルタや移動平均フィルタを適用し、フレーム間の微細なブレを抑制する。

2. **Temporal Attentionの導入**:
   - 以前のフレームの特徴量を現在のフレームの推論に利用する仕組み（Temporal Module）をRT-DETRに追加することを検討する。

### P2（中優先）: モデルアーキテクチャの微調整
TNetおよびRT-DETRの構造的な最適化。

1. **アンカー設定の見直し（もし使用している場合）**:
   - コートのアスペクト比に特化したアンカーボックスの再設計、またはアンカーフリー検出ヘッドのパラメータ調整。

2. **損失関数（Loss Function）の調整**:
   - コートのキーポイント（四隅など）の検出精度を重視するため、IoU Lossに加えて、Keypoint Regression Lossの重みを調整する。
   - Hard Example Mining (OHEM) を導入し、検出が難しいケース（遠くのコートや極端なアングル）の学習を強化する。

### P3（低優先）: 幾何学的制約によるポストプロセス
コートの形状が既知であることを利用した補正。

1. **ホモグラフィ変換による整合性チェック**:
   - 検出されたコート領域からホモグラフィ行列を推定し、実際のコート規格（サイズ・比率）と照らし合わせて、逸脱が大きい検出結果を破棄または補正する。
   - 直線検出（Hough変換など）を補助的に用い、ラインの歪みを補正する。

2. **アンサンブル推論**:
   - 異なるスケールやAugmentationを適用した入力画像を推論し、結果を統合（WBF: Weighted Boxes Fusionなど）することで精度を底上げする（ただし推論速度とのトレードオフあり）。

## 今後の進め方
1. まずは P1 のデータオーグメンテーション強化から着手し、ベースラインモデルの精度向上を確認する。
2. 次に P2 の時間的整合性の処理をパイプラインに組み込み、動画での見た目の安定化を図る。
3. 必要に応じてモデル構造の変更やポストプロセスの追加を検討する。
