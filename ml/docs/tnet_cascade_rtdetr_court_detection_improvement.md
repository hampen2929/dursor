# tnet_cascade_rtdetr Court検出改善計画

## 概要

本ドキュメントは、`tnet_cascade_rtdetr` モデルにおけるCourt検出の安定化に向けた改善案を優先度付きでまとめたものです。

## 現状の課題

推論結果を描画した動画からの定性評価により、以下の課題が特定されています：

| データセット | 課題 |
|-------------|------|
| **Validation** | カメラが低い位置にある動画において、奥側の検出がブレて誤検出・見逃しが増加 |
| **Test** | 奥側の検出がブレて誤検出・見逃しが増加 |

### 課題の根本原因分析

1. **距離による見え方の変化**: 奥側のコートは画像上でサイズが小さくなり、特徴量が不足
2. **カメラ角度の影響**: 低いカメラ位置ではコートの遠方部分が圧縮されて見える
3. **パースペクティブ歪み**: 奥側のコートラインは角度が急になり、検出が困難
4. **時間的不安定性**: フレーム間での検出位置のブレ

---

## 改善案一覧

### P0（最優先）: 即効性のある改善

#### P0-1: 時間的スムージング（ポストプロセッシング）
**概要**: 動画の連続フレーム間で検出結果を平滑化し、ブレを抑制

**実装案**:
- 移動平均フィルタによるバウンディングボックス座標の平滑化
- カルマンフィルタによるトラッキングベースの安定化
- 信頼度スコアの時間的重み付け平均

**期待効果**: 
- 検出のブレを即座に軽減
- モデル再学習不要で迅速に導入可能

**工数**: 小（1-2日）

---

#### P0-2: 信頼度閾値の動的調整
**概要**: 奥側（画像下部）の検出に対して信頼度閾値を調整

**実装案**:
- 画像のY座標に応じた閾値の段階的調整
- 奥側の検出に対してより低い閾値を適用（見逃し対策）
- NMS（Non-Maximum Suppression）のIoU閾値を距離に応じて調整

**期待効果**: 
- 奥側の見逃し減少
- 誤検出と見逃しのトレードオフ調整が可能

**工数**: 小（1日）

---

### P1（高優先）: モデル改善

#### P1-1: 奥側に特化したデータ拡張
**概要**: 低カメラ位置・奥側コートが強調されるデータ拡張を追加

**実装案**:
- パースペクティブ変換による低カメラ角度のシミュレーション
- 画像下部（奥側）を含むクロップの比率増加
- 奥側のコートが見える画像の重み付けサンプリング

**期待効果**: 
- 奥側検出に対するモデルの汎化性能向上

**工数**: 中（3-5日）

---

#### P1-2: マルチスケール特徴強化
**概要**: 小さいオブジェクト（奥側のコート）の特徴抽出を強化

**実装案**:
- FPN（Feature Pyramid Network）の低レベル特徴の活用強化
- RT-DETRのEncoder/Decoderレイヤー数の調整
- 高解像度特徴マップの保持

**期待効果**: 
- 小さいオブジェクトの検出精度向上

**工数**: 中（3-5日）

---

#### P1-3: 損失関数の調整
**概要**: 奥側の検出に対する損失の重み付けを強化

**実装案**:
- バウンディングボックスのY座標（奥側）に応じた損失の重み付け
- Focal Lossのγパラメータ調整
- IoU Lossの距離に応じた補正

**期待効果**: 
- モデルが奥側の検出をより重視するようになる

**工数**: 中（2-3日）

---

### P2（中優先）: アーキテクチャ改善

#### P2-1: Attention機構の強化
**概要**: 奥側の特徴に対するAttentionを強化

**実装案**:
- Spatial Attentionの追加（奥側領域への注目強化）
- Deformable Attentionのsampling point数の増加
- Position Encodingの改善（距離情報の明示的な埋め込み）

**期待効果**: 
- 奥側の特徴をより効果的に捉える

**工数**: 大（1週間）

---

#### P2-2: 時間的一貫性の学習
**概要**: 動画の時間的情報をモデルに組み込み

**実装案**:
- Temporal Attentionの追加
- 連続フレームを入力とするモデル構造への変更
- Optical Flowを活用した特徴伝播

**期待効果**: 
- フレーム間の検出の一貫性向上

**工数**: 大（1-2週間）

---

### P3（低優先）: 長期的改善

#### P3-1: 専用データセットの構築
**概要**: 低カメラ位置・奥側検出に特化したデータセットを追加収集

**実装案**:
- 低カメラ位置からの撮影データの追加収集
- 奥側のコートが明確に見える角度からのデータ
- ハードケースのアノテーション強化

**期待効果**: 
- 根本的なモデル性能向上

**工数**: 大（2週間以上）

---

#### P3-2: 2段階検出アプローチ
**概要**: コート全体の検出後、奥側を詳細に再検出

**実装案**:
- 第1段階: コート全体の粗い検出
- 第2段階: 奥側領域の高解像度処理による詳細検出
- カスケード構造の活用

**期待効果**: 
- 奥側の検出精度の大幅な向上

**工数**: 大（2-3週間）

---

## 推奨実装順序

```
Phase 1（即効性重視）: P0-1 → P0-2
  ↓
Phase 2（モデル改善）: P1-1 → P1-3 → P1-2
  ↓
Phase 3（アーキテクチャ）: P2-1 → P2-2
  ↓
Phase 4（長期施策）: P3-1 → P3-2
```

## 評価指標

改善効果を測定するための指標：

| 指標 | 説明 |
|------|------|
| **mAP (全体)** | 全体的な検出精度 |
| **mAP (奥側)** | 画像下部1/3領域の検出精度 |
| **検出安定性** | 連続フレーム間のIoUの分散 |
| **見逃し率 (奥側)** | 奥側のGTに対する見逃し率 |
| **誤検出率 (奥側)** | 奥側の誤検出数 / 全検出数 |

## 参考情報

- 元課題: `ml/docs/tnet_cascade_rtdetr_detection_improvement.md` - P2（中優先）: Court検出の安定化
- モデル: `tnet_cascade_rtdetr`
