## 目的

`tnet_cascade_rtdetr` の **ball 検出精度を「後処理頼み」ではなく、検出そのものの精度向上で改善する**。
特に「特定の箇所で誤検出（FP）が多発する」問題を最優先で潰す。

### 前提（このメモの立ち位置）

- 後処理（閾値調整、NMS/Soft-NMS、トラッキング、ルールベース抑制など）は一定試したが、**根本の検出品質が足りず限界**。
- 誤検出が「場面全体に薄く出る」のではなく、**特定の見た目・特定の位置・特定の背景で集中的に出る**。
- よって対策の中心は **学習データ／ラベル／学習設計**（＝モデルが誤検出を出さない境界を学習する）に置く。

---

## まず揃えるべき評価指標（KPI）

mAP だけだと「特定箇所のFP多発」が埋もれやすい。以下を併走する。

- **KPI-1: FP@region（誤検出多発箇所ごとのFP率）**
  - 誤検出が多い領域（固定カメラなら画像座標で ROI）ごとに FP を集計
- **KPI-2: Recall@FP固定**
  - 例: 「1分あたりFP ≤ X」など FP 制約下での再現率
- **KPI-3: Hard-negative FP rate**
  - “誤検出が出る見た目カテゴリ”ごとの FP 率

> 後処理を頑張っても無意味になりがちなケースは、KPI-1/3 が悪いまま、閾値で誤魔化して KPI-2 を崩す（見逃し増）パターン。

---

## 誤検出（FP）の型を分類する（最重要の準備）

「特定箇所」の正体を、学習可能な単位に落とす。

### 分類のやり方（推奨）

推論結果を見て、FP を 3〜10 種類に分類する（最初は粗くて良い）。

例:
- `distractor_glare`（ハイライト/反射）
- `distractor_line`（ライン/白帯）
- `distractor_logo_text`（ロゴ/文字/スコア表示）
- `distractor_net`（ネットの結び目/白い点）
- `distractor_people`（肌/シューズの白い部分）
- `distractor_ball_like_object`（実際に球に近い小物）

分類できると、**「どの施策がどのFPに効いたか」** を定量で追える。

---

## 優先度付き 改善案（P0 → P3）

### P0（最優先）ハードネガティブで「その誤検出」を学習で殺す

後処理ではなく、**その見た目を ball ではないと学習させる**。

#### P0-1: Hard Negative Mining（必須）

- **やること**
  - 現行モデルで動画/画像を広く推論
  - FP が出たフレーム（または近傍±数フレーム）だけを抽出
  - ball が本当に無い/別位置にあることを確認し、学習データに投入
- **狙い**
  - 「まさにそこで誤検出する見た目」を、学習の中心に持ち込む
- **成功条件**
  - KPI-1（FP@region）と KPI-3（Hard-negative FP rate）が確実に下がる
- **注意**
  - ネガティブを薄く増やすより、**誤検出タイプごとに濃く増やす**方が効きやすい

#### P0-2: ディストラクタ別クラス化（強く推奨）

- **やること**
  - FP の主因が数種類に収束する場合、`ball` とは別に `distractor_*` をクラスとしてアノテーション
  - 推論では `ball` のみ採用（`distractor_*` は捨てる）
- **狙い**
  - 背景として押し込むより「別クラス」として明示した方が学習信号が強く、FP が落ちる
- **判断基準**
  - “特定箇所FP”が 1〜3 パターンに偏っているなら実施価値が高い

#### P0-3: “No-ball”フレーム（負例）を意図的に入れる

- **やること**
  - ball が確実に映らない区間（プレー間、観客席、引きの画、空など）をまとまって追加
- **狙い**
  - 「何も無いのに出す」タイプのFPを抑える（特定箇所FPの土台を削る）

#### P0-4: ラベル品質の重点監査（小物体は特に効く）

- **やること**
  - 小物体のボックスズレ、欠落、曖昧ラベルを重点的に修正
- **狙い**
  - 小物体検出ではラベルノイズが境界学習に直撃し、FP/見逃しの両方を悪化させる

---

### P1（次点）小物体として見えるようにする：クロップと現場劣化Aug

#### P1-1: Ball中心クロップ（拡大）を学習に入れる

- **やること**
  - 一定割合で ball 周辺を切り出して拡大（ballが十分なピクセルサイズになるよう調整）
- **狙い**
  - 「ball が潰れて別物に見える」状態を減らし、誤検出/見逃しの両方を改善

#### P1-2: 現場劣化の再現Aug（ブラー・圧縮・露出）

- **やること**
  - motion blur / gaussian blur / jpeg artifacts / gamma / 露出ゆらぎ等
- **狙い**
  - ball とディストラクタが “見た目で近づく” 状況への頑健性を上げる

#### P1-3: Copy-Paste（合成）を「誤検出箇所」に使う

- **やること**
  - ball パッチを誤検出が出やすい背景へ、サイズ・ブラー・輝度を合わせて貼る
- **狙い**
  - 「その背景で ball/非ball を分ける」学習信号を強化

---

### P2（チューニング）FPを下げる最適化に寄せる

#### P2-1: 入力解像度・マルチスケール再検討

- **狙い**
  - ball が常に数px級なら、解像度不足は後処理で救えない

#### P2-2: 難例重み付け（Hard例に学習を寄せる）

- **狙い**
  - “特定箇所FP”のような難例を強く学習する（focal相当、OHEM相当の運用）

#### P2-3: 学習・検証の分割を「誤検出箇所リーク」しない形にする

- **狙い**
  - 固定カメラ/固定会場が混在する場合、同一背景が train/val に跨ると過大評価になりやすい

---

### P3（必要なら）モデル側に踏み込む：小物体に強い構造へ

#### P3-1: 小物体向けの特徴解像度（浅い特徴）をより活用

- **狙い**
  - stride が粗く ball が特徴上で消える問題を減らす

#### P3-2: 2段構え（ROI）を “後処理”ではなく “学習設計”で取り込む

- **例**
  - 先に court/field を推定 → ROI 内で ball 検出を学習（入力クロップ/条件付き学習）
- **狙い**
  - 「コート外の誤検出」をモデルが構造的に出しにくくする

---

## 推奨の実行順（最短ルート）

### フェーズA（最優先：1〜3日で形にする）

- FP を 3〜10 種類に分類（Hard-negative taxonomy）
- Hard Negative Mining 用のデータ抽出パイプを用意
- “特定箇所FP”を各カテゴリで **濃く** 集める

### フェーズB（効果が出るまで回す：1〜2週間）

- `distractor_*` クラス化（可能なら）
- ball中心クロップ＋現場劣化Aug
- KPI-1/3 を見ながら学習を回し、どのFPが落ちたかを記録

### フェーズC（必要なら）

- 解像度/スケール/難例重み付けの最適化
- モデル側の小物体強化（P3）

---

## 失敗しがちな落とし穴

- **閾値を上げてFPを減らす** → 見逃しが増え、KPI-2 が崩れる（根治していない）
- ネガティブを “広く薄く” 追加するだけ → **特定箇所のFPは残る**（Hard例が薄い）
- 誤検出の型が未分類 → 施策の効果が見えず、改善サイクルが回らない

---

## TODO（このmdをアップデートしていく項目）

- 誤検出多発「特定箇所」の具体例（スクショ/動画ID/座標ROI）
- FP taxonomy（分類表）と各カテゴリの件数
- 各施策（P0/P1/P2）の実験ログ（KPI-1/2/3の推移）

