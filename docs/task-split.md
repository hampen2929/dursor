# ヒアリング文章の貼り付け → タスク分解 → 登録（Task Split）機能 追加計画

## 背景 / 目的

現実世界で行ったヒアリング（議事録・メモ・録音起こし等）をそのまま貼り付け、**機能追加やバグ修正のタスクに分解して登録**できるようにします。

想定する開発フローは以下です。

- ヒアリングを行う（現実世界）
- ヒアリング時の文章を貼り付けて、機能追加/バグ修正のタスクに分解して登録
- 登録されたタスクを選択して実行（既存機能：タスク詳細でメッセージ→Run作成）

## 既存UI/データフロー（前提整理）

- **Home** (`apps/web/src/app/page.tsx`)
  - 指示入力 → `tasksApi.create` → `tasksApi.addMessage` → `runsApi.create` → `tasks/[taskId]` に遷移
- **Sidebar** (`apps/web/src/components/Sidebar.tsx`)
  - タスク一覧・検索・並び替え、`New Task`（Homeへ）
- **Task詳細** (`apps/web/src/app/tasks/[taskId]/page.tsx` + `ChatCodeView`)
  - 会話（メッセージ）とRun、PR作成など（既存）

このため「タスク分解→登録」は **Home（新規作成入口）** に置くのが最も自然です。加えて、運用上は Sidebar からも入りたいケースが多いので **補助導線として Sidebar にも追加**します。

---

## UIに追加する場所（提案）

### 1) メイン導線：Home の入力エリア付近（推奨）

Homeの「指示入力」カードは“作業を始める入口”なので、ここに **「ヒアリングからタスクを作る」**ボタン/リンクを追加します。

- 位置案（優先順）
  - **A. 入力欄の右上/右下のアクション列**に「ヒアリング貼り付け」ボタン（主導線）
  - **B. 入力欄プレースホルダ下にチップ**（例：「ヒアリングを貼り付けてタスク分解」）

クリックすると **モーダル（既存 `ui/Modal`）** を開き、貼り付け・分解・プレビュー・一括登録を行います。

### 2) 補助導線：Sidebar の「New Task」周り

Sidebarの `New Task` は既存導線（Homeへ）なので、以下のいずれかを追加します。

- **ドロップダウン化**: `New Task` / `ヒアリングから分解` の2択
- もしくは `New Task` 直下に小さなサブボタン「ヒアリングから分解」

---

## 画面/体験設計（MVP）

### ユーザーフロー

1. Home で「ヒアリングからタスクを作る」を押す
2. モーダルにヒアリング文章を貼り付け
3. 分解を実行（LLM利用。未設定時は簡易ルールでフォールバック）
4. 分解結果をプレビュー（タイトル/種別/優先度/説明の編集、不要タスク削除、結合）
5. 「登録」すると **複数タスクが作成**され、Sidebarに並ぶ
6. ユーザーは作成したタスクを開き、既存の「Run実行」フローで進める

### モーダル構成（ワイヤー）

```
┌──────────────────────────────────────────────┐
│ ヒアリングからタスクを作成                   │
│                                              │
│ [対象Repo/Branch]  (Homeで選択済みを初期値)   │
│                                              │
│ ヒアリング文章（貼り付け）                   │
│ ┌──────────────────────────────────────────┐ │
│ │                                          │ │
│ │  (議事録/メモをそのまま貼り付け)          │ │
│ │                                          │ │
│ └──────────────────────────────────────────┘ │
│                                              │
│ オプション: 粒度 [粗/標準/細]  最大件数 [20]   │
│            種別推定 [ON]  受け入れ条件生成 [ON] │
│                                              │
│ [分解する]                                   │
│                                              │
│ 分解結果プレビュー                            │
│ ┌──────────────────────────────────────────┐ │
│ │ [ ] BUG: ログイン時に500になる            │ │
│ │     - 再現手順… / 期待結果…               │ │
│ │ [ ] FEAT: 設定画面に通知トグル追加         │ │
│ │     - 受け入れ条件…                        │ │
│ │  ...（編集/削除/結合）                     │ │
│ └──────────────────────────────────────────┘ │
│                                              │
│ [キャンセル]                      [登録する] │
└──────────────────────────────────────────────┘
```

### 「登録」時に作るデータ（既存モデルに合わせる）

既存は Task に `title` があり、Message に `content` が入ります。分解後の各タスクについて：

- Task:
  - `title`: 50文字程度の要約（UI表示に適した短文）
- Message（初回メッセージとして自動投入）:
  - `role`: `user`
  - `content`: 分解したタスク本文（背景/要件/受け入れ条件/補足など）

これにより、ユーザーはそのタスクを開いた瞬間に「実行可能な指示」が置かれている状態になります。

---

## API設計（提案）

### 方針

- **分解（提案生成）**と**登録（永続化）**を分ける
  - UIで編集・削除・結合ができるため、**プレビューをユーザーが確定してから**一括登録したい
- DBスキーマ変更なしでMVPを成立させる
  - `TaskDAO.create` と `MessageDAO.create` を複数回呼ぶだけで登録可能

### 1) タスク分解 API（プレビュー生成）

`POST /v1/tasks/split`

- Request（例）
  - `repo_id`: string（必須）
  - `text`: string（必須：ヒアリング文章）
  - `language`: string（任意。デフォルト `ja`）
  - `granularity`: `"coarse" | "normal" | "fine"`（任意）
  - `max_tasks`: number（任意。デフォルト 20）
  - `include_acceptance_criteria`: boolean（任意）
  - `infer_type_and_priority`: boolean（任意）
  - `model_id`: string（任意。LLMで分解する場合に使用。未指定時は“推奨モデル”を自動選択）

- Response（例）
  - `proposals`: array
    - `title`: string
    - `type`: `"feat" | "bug" | "chore" | "question"`（推定）
    - `priority`: `"p0" | "p1" | "p2" | "p3"`（推定）
    - `description`: string（そのまま初回メッセージに使える粒度）
    - `rationale`: string（任意。なぜそう分けたか。UIでは折り畳み）
    - `confidence`: number（0〜1、任意）
  - `warnings`: string[]（例：不明点が多い/曖昧な箇所）

### 2) タスク一括作成 API（確定したプレビューを登録）

`POST /v1/tasks/bulk`

- Request（例）
  - `repo_id`: string
  - `tasks`: array
    - `title`: string
    - `initial_message`: string（= Message.content）

- Response（例）
  - `task_ids`: string[]

#### 既存APIとの整合

既存は
- `POST /tasks`（単発作成）
- `POST /tasks/{id}/messages`（メッセージ追加）

なので Bulk はこれらをサーバ側でまとめて行う薄いラッパーとして実装できます。

---

## 分解ロジック（MVPの中身）

### 基本（LLM分解）

バックエンドでLLMに以下の目的を渡します：

- 入力：ヒアリング文章（長文OK）
- 出力：実行可能な粒度の「機能/バグ」タスク配列
- 重要：**“実装タスク”として成立する情報（背景・要件・受け入れ条件）**を揃える

実装上は `LLMRouter` + `ModelService` を利用し、`model_id` のAPIキーを復号して呼び出します（Run実行のPatchAgentと同様の構造）。

### フォールバック（モデル未設定時）

モデルが1件も登録されていない場合でも機能を“壊さない”ために、以下の簡易分割を用意します。

- 箇条書き（`-`/`*`/`・`）や見出し（`##`）単位で分割して `title` を作る
- `description` は該当ブロックをそのまま入れる
- `type/priority` は空 or 既定値（`chore`/`p2`）

UI側では「モデルが未登録なので簡易分解になります。精度を上げるには Settings でモデルを追加してください」を表示。

---

## エッジケース / 仕様（重要）

### 1) 機密情報・個人情報（PII）

ヒアリング文には氏名/メール/顧客情報が入りがちです。

- モーダルに注意書き（「外部LLMに送信されます」）を表示
- オプションで「固有名詞を伏せる（簡易マスク）」を提供（MVPではUIのみ・正規表現レベルでも可）
- サーバログに生文を出さない（エラー時も本文を含めない）

### 2) タスク粒度の制御

粒度は「粗/標準/細」で十分です（MVP）。

- 粗：大項目中心（5〜10件）
- 標準：実装単位（10〜20件）
- 細：工程まで分割（最大件数で抑制）

### 3) “質問”タスクの扱い

ヒアリングからは不明点が必ず出るので、`question` タイプを許容し、
「確認事項（質問）」としてタスク化できると運用が回ります（後で聞き返すため）。

---

## 実装計画（ステップ）

### Phase 0: 仕様確定（半日〜1日）

- UI導線（Home主導線 + Sidebar補助導線）の確定
- APIのリクエスト/レスポンス形（上記）確定
- 既定の粒度/最大件数/注意書き文言の確定

### Phase 1: Backend（MVP）

- `POST /v1/tasks/split` を追加
  - LLM利用時：`model_id` を受け取り、`ModelService.get_decrypted_key()` でキー取得→LLM呼び出し
  - モデル未設定時：ルールベースフォールバック
  - 返却形式を `proposals[]` に統一（UI側は同一表示）
- `POST /v1/tasks/bulk` を追加
  - `TaskDAO.create` と `MessageDAO.create` を繰り返し呼ぶ
  - 途中失敗時の扱い：MVPは「失敗した時点でエラー」でも良いが、可能ならトランザクション（SQLite）で全体を守る

### Phase 2: Frontend（MVP）

- `TaskSplitModal`（新規コンポーネント）を作成
  - 入力テキスト、オプション、分解実行、プレビュー編集、登録
  - `Toast` で成功/失敗通知
- Home にボタン追加（主導線）
  - `selectedRepo/branch` が未選択の場合はモーダル内で警告（または選択UIを内包）
- Sidebar に補助導線追加
  - Home のモーダルを開けるように（遷移して `#task-split` のようなハッシュで開く方式が簡単）

### Phase 3: 改善（任意）

- 分解結果の「結合」「重複排除」「並び替え」補助
- 分解のやり直し（粒度変更で再生成）
- 「タスクバッチ（元文章と生成結果の関連付け）」をDBに保存（監査/再生成に有効）

---

## 将来拡張（アイデア）

- **タスクテンプレート**（バグ/機能で入力項目を標準化）
- **タグ/ラベル**（`frontend`/`backend`/`docs` などの自動推定と検索）
- **担当者/見積り**（運用向け）
- **“1タスク = 1PR”の自動ガイド**（PR分割の習慣化）

---

## 受け入れ条件（MVP）

- ユーザーがヒアリング文章を貼り付け、複数タスクのプレビューを得られる
- プレビューを編集して一括登録できる
- 登録された各タスクには初回メッセージが入っており、既存の「タスクを選択して実行」フローにそのまま乗る
- モデル未設定でも簡易分解で最低限動作する

